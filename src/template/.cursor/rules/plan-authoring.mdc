---
description: Cursor plan format; always use rich planning aligned with docs/plan-format.md
globs: plans/**/*.md
alwaysApply: false
---

# Plan Authoring (Cursor Format)

**Before writing a plan you MUST use the planner-analyst sub-agent.** See `.cursor/rules/subagent-dispatch.mdc` → Pattern 3. Dispatch the planner-analyst with the user's request, wait for its structured analysis (relevant files, existing data, patterns, risks, rough task breakdown), then write the plan using that output. Do not create a plan from scratch without analyst context.

Create plans as `plans/<name>.md` (not .plan.md). Plans use Cursor format for import into taskgraph via `tg import --format cursor`.

## Import robustness and validation

- **Validate before done**: Run `pnpm tg import plans/<file> --plan "<Plan Name>" --format cursor` to verify the plan imports. If it fails, the CLI now surfaces the underlying YAML parse cause; fix the frontmatter or use a minimal frontmatter and put rich content in the body.
- **Minimal frontmatter (when import fails)**: See [Plan Import Robustness](docs/plan-format.md#plan-import-robustness) in docs/plan-format.md. Use only `name`, single-line `overview`, `todos` with `id`, `content`, `status`, and optional `blockedBy: [id]`. Put intent, fileTree, risks, tests, and suggestedChanges in the **markdown body** so the file still imports. Checklist: no em dash in name; single-line overview; run `tg import` to verify.

## Plan file naming (timestamp convention)

Plan filenames MUST include a date prefix so they sort chronologically. Use this format:

- **Format**: `yy-mm-dd_the_file_name.md` (e.g. `26-02-26_restructure_src_npm_layout.md`). Two-digit year, then date, then underscore, then the plan slug.
- **When to set the date**: Use the plan's creation date or the date the plan was completed (e.g. when running `tg export markdown` after the last task is done).
- **File name**: Lowercase, words separated by underscores; no spaces or colons (e.g. `multi_agent_centaur`, `fix_failing_tests_properly_4afac574`).
- **New plans / export**: Use current date when creating. Export writes to `exports/<planId>.md` by default; do not write into `plans/` (blocked by CLI).

**Always use the rich planning format** as defined in [docs/plan-format.md](../docs/plan-format.md). Plans are research artifacts: they must carry enough structure and analysis that `tg context` and the executing agent get file trees, risks, tests, and per-task intent/suggested changes.

## Rich planning (required)

Every plan MUST align with the enhanced format in docs/plan-format.md:

| Element              | Required       | Description                                                                                                                                                            |
| -------------------- | -------------- | ---------------------------------------------------------------------------------------------------------------------------------------------------------------------- |
| **fileTree**         | yes            | Plan-level. Tree of files the plan touches, with `(create)` / `(modify)`. Stored on plan, shown in `tg context`.                                                       |
| **risks**            | yes            | Plan-level array of `{ description, severity, mitigation }`. `severity`: `low`, `medium`, `high`.                                                                      |
| **tests**            | yes            | Plan-level array of strings describing tests to add.                                                                                                                   |
| **intent**           | yes (per todo) | Detailed description of what the task involves and why. Stored on task, shown in `tg context`.                                                                         |
| **suggestedChanges** | when helpful   | Per todo. Directional code snippets or pointers for the agent; not prescriptive.                                                                                       |
| **Markdown body**    | yes            | Below the closing `---`: Analysis, proposed changes, mermaid (e.g. dependency graph), risks/testing/open questions. End with `<original_prompt>...</original_prompt>`. |

- **Mermaid**: Use for data flows, state machines, dependency graphs, or any logic that benefits from a diagram.
- **suggestedChanges**: Add when a task touches a specific file/function; a short snippet speeds the agent up.

## YAML Frontmatter Structure

```yaml
---
name: Plan Name
overview: |
  Multi-line overview; can include why and scope.
fileTree: |
  path/to/file.ts    (modify)
  path/to/new.ts     (create)
risks:
  - description: What could go wrong
    severity: medium
    mitigation: How we address it
tests:
  - "Test description 1"
  - "Test description 2"
todos:
  - id: stable-key
    content: "Task title (concise; under 255 chars)"
    intent: |
      Detailed scope, rationale, and references to code.
    suggestedChanges: |
      Optional snippet or pointer for the agent.
    blockedBy: [other-id]
    domain: [schema, cli]
    skill: [cli-command-implementation]
    changeType: modify
isProject: false
---
```

Below the closing `---`, add the markdown body: **Analysis**, **Proposed changes** (or Mermaid), **Open questions**, and end with `<original_prompt>...</original_prompt>`.

## Todo Fields

| Field              | Required | Description                                                                         |
| ------------------ | -------- | ----------------------------------------------------------------------------------- |
| `id`               | yes      | Stable key → maps to `external_key` (import adds 6-char plan hash). Use kebab-case. |
| `content`          | yes      | Task title (maps to task title; VARCHAR(255) — keep under 255 chars).               |
| `intent`           | yes      | Detailed scope and rationale; stored on task, shown in `tg context`.                |
| `status`           | no       | `pending` → todo, `completed` → done                                                |
| `blockedBy`        | no       | Array of todo `id`s that block this task. Creates `blocks` edges on import.         |
| `domain`           | no       | Single slug or array → `docs/<domain>.md`. Agent reads these before starting.       |
| `skill`            | no       | Single slug or array → `docs/skills/<skill>.md`. Use kebab-case.                    |
| `changeType`       | no       | `create`, `modify`, `refactor`, `fix`, `investigate`, `test`, `document`.           |
| `suggestedChanges` | no       | Directional snippets for the agent when the task touches specific code.             |

## Dependency and scope

- Use `blockedBy` for tasks that cannot start until others are done.
- Reference `id` values; they resolve to task IDs when importing.
- Keep tasks scoped (~90 min or less); split large ones.
- **Parallel-ready**: Plans MUST have ≥2 tasks with no `blockedBy` so the orchestrator can dispatch in parallel. If all tasks are serial, restructure: docs, tests, and independent features rarely need to block on each other. For each `blockedBy`, ask "can this task work without the upstream?" — if yes, remove the dependency.
- Order todos to reflect dependency graph when possible.
